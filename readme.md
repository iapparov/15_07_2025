# Архиватор файлов по ссылкам

## Описание

Сервис позволяет пользователю создавать задачи на скачивание файлов по публичным ссылкам, архивировать их в zip и получать ссылку на архив.  
Поддерживаются только файлы с расширениями `.pdf`, `.jpg` (или иные, указанные в конфиге).  
В одной задаче — не более 3 файлов.  
Одновременно может обрабатываться не более 3 задач.  
Если файл по ссылке недоступен, сервис сообщает об этом, но остальные файлы всё равно архивируются.

---

## Структура проекта

```
15_07_2025/
├── cmd/
│   └── main.go                # Точка входа, запуск fx-приложения
├── config/
│   └── local.yaml             # Конфигурация сервиса
├── internal/
│   ├── app/
│   │   └── zip_service.go     # Логика скачивания и архивирования
│   ├── config/
│   │   └── config.go          # Загрузка и парсинг конфига
│   ├── datasource/
│   │   └── model.go           # Модели данных (Storage, Status)
│   ├── di/
│   │   └── service.go         # DI и запуск HTTP-сервера
│   └── web/
│       ├── handler.go         # HTTP-обработчики
│       └── router.go          # Маршрутизация
├── archive/                   # Папка для архивов

```

---

## Запуск

1. **Соберите проект:**
   ```sh
   go build -o archiver ./cmd
   ```

2. **Укажите путь к конфигу:**
   ```sh
   export CONFIG_PATH=./config/local.yaml
   ```

3. **Запустите сервис:**
   ```sh
   ./archiver
   ```

4. **Сервис будет доступен на порту, указанном в конфиге (по умолчанию 8080).**

---

## Примеры использования API

### 1. Создать задачу

```http
POST /tasks
```

**Ответ:**
```json
"e7e6c5a2-...-..." // UUID задачи
```

### 2. Добавить ссылки на файлы в задачу

```http
POST /tasks/{id}/add
Content-Type: application/json

{
  "file1": "https://example.com/file1.pdf",
  "file2": "https://example.com/file2.jpg"
}
```

**Ответ:**
```json
{
  "added": [
    "https://example.com/file1.pdf",
    "https://example.com/file2.jpg"
  ],
  "skipped": []
}
```

### 3. Проверить статус задачи

```http
GET /tasks/{id}/status
```

**Ответ:**
```json
"task status: Ready"
```
или
```json
"task status: Done"
archive address: http://localhost:8080/archives/e7e6c5a2-...-....zip
```

---

## Особенности и нюансы

- **Потокобезопасность:**  
  Все обращения к map задач защищены мьютексом.
- **Ограничение на количество задач:**  
  Если в работе уже 3 задачи, новые не принимаются (HTTP 429).
- **Ограничение на количество файлов:**  
  В задаче не более 3 файлов, остальные игнорируются.
- **Фильтрация расширений:**  
  Только расширения из конфига (по умолчанию .pdf, .jpg).
- **Архивы:**  
  Хранятся в папке, указанной в конфиге (`archive_path`). 
- **Ошибки скачивания:**  
  Если файл не скачался, он не попадает в архив, а в статусе задачи будет ошибка.
- **Конфиг:**  
  Все параметры (порт, расширения, лимиты, путь к архивам) задаются через YAML.

---

## Пример конфига (`config/local.yaml`)

```yaml
env: local
http_port: 8080
max_tasks: 3
allowed_types: 
  - jpg 
  - pdf
max_objects: 3
archive_path: "./archive"
```

---

## Важно

- **Не используйте сервис для скачивания больших файлов или большого количества задач — это демо-реализация без очередей и БД.**
- **Вся информация о задачах хранится в памяти — после перезапуска приложения задачи теряются.**
- **Папка для архивов должна быть доступна для записи.**

---

## Используемые паттерны

- **Dependency Injection** (через fx)
- **Repository in-memory** (map + mutex)
- **Worker pattern** (фоновая горутина для архивирования)

---

## Пример запроса через curl

```sh
# Создать задачу
curl -s -X POST http://localhost:8080/tasks

# Добавить файлы
curl -X POST http://localhost:8080/tasks/{TASK_ID}/add \ 
  -H "Content-Type: application/json" \
  -d '{"file1":"https://example.com/file1.pdf","file2":"https://example.com/file2.jpg"}'
  

# Проверить статус
curl http://localhost:8080/tasks/{TASK_ID}/status
```

---
